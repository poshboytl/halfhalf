#!/usr/bin/env ruby
# Half & Half CLI - OpenClaw 专属客户端

require "fileutils"
require "json"

APP_ROOT = File.expand_path("..", __dir__)
PLIST_PATH = File.expand_path("~/Library/LaunchAgents/com.halfhalf.server.plist")
PID_FILE = File.join(APP_ROOT, "tmp/pids/server.pid")
LOG_FILE = File.join(APP_ROOT, "log/production.log")
PORT = ENV["HALFHALF_PORT"] || "1314"

def ensure_dirs
  FileUtils.mkdir_p(File.join(APP_ROOT, "tmp/pids"))
  FileUtils.mkdir_p(File.join(APP_ROOT, "log"))
end

def plist_content
  <<~PLIST
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
      <key>Label</key>
      <string>com.halfhalf.server</string>
      <key>ProgramArguments</key>
      <array>
        <string>#{APP_ROOT}/bin/halfhalf</string>
        <string>run</string>
      </array>
      <key>WorkingDirectory</key>
      <string>#{APP_ROOT}</string>
      <key>RunAtLoad</key>
      <true/>
      <key>KeepAlive</key>
      <true/>
      <key>StandardOutPath</key>
      <string>#{LOG_FILE}</string>
      <key>StandardErrorPath</key>
      <string>#{LOG_FILE}</string>
      <key>EnvironmentVariables</key>
      <dict>
        <key>PATH</key>
        <string>/Users/fiona/.rbenv/shims:/Users/fiona/.rbenv/bin:/opt/homebrew/opt/postgresql@17/bin:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin</string>
        <key>RAILS_ENV</key>
        <string>production</string>
        <key>HALFHALF_PORT</key>
        <string>#{PORT}</string>
      </dict>
    </dict>
    </plist>
  PLIST
end

def install
  ensure_dirs
  File.write(PLIST_PATH, plist_content)
  puts "✅ Installed launchd service"
  puts "   Run 'halfhalf start' to start the server"
end

def uninstall
  stop if running?
  FileUtils.rm_f(PLIST_PATH)
  puts "✅ Uninstalled launchd service"
end

def start
  unless File.exist?(PLIST_PATH)
    puts "Service not installed. Running 'halfhalf install' first..."
    install
  end
  
  system("launchctl load #{PLIST_PATH}")
  sleep 2
  
  if running?
    puts "✅ Half & Half started on port #{PORT}"
    puts "   Access: http://localhost:#{PORT}"
    show_tailscale_ip
  else
    puts "❌ Failed to start. Check logs: #{LOG_FILE}"
  end
end

def stop
  if File.exist?(PLIST_PATH)
    system("launchctl unload #{PLIST_PATH}")
  end
  
  if File.exist?(PID_FILE)
    pid = File.read(PID_FILE).strip.to_i
    Process.kill("TERM", pid) rescue nil
    FileUtils.rm_f(PID_FILE)
  end
  
  puts "✅ Half & Half stopped"
end

def restart
  stop
  sleep 1
  start
end

def status
  if running?
    pid = File.read(PID_FILE).strip rescue "unknown"
    puts "✅ Half & Half is running (PID: #{pid})"
    puts "   Port: #{PORT}"
    show_tailscale_ip
    show_openclaw_status
  else
    puts "❌ Half & Half is not running"
  end
end

def running?
  return false unless File.exist?(PID_FILE)
  pid = File.read(PID_FILE).strip.to_i
  Process.kill(0, pid)
  true
rescue Errno::ESRCH, Errno::ENOENT
  false
end

def run
  # 直接运行（用于 launchd）
  ensure_dirs
  Dir.chdir(APP_ROOT)
  
  # 确保数据库存在
  system("bin/rails db:prepare RAILS_ENV=production")
  
  # 编译 CSS
  system("bin/rails tailwindcss:build RAILS_ENV=production")
  
  # 启动服务器
  exec("bin/rails server -b 0.0.0.0 -p #{PORT} -e production")
end

def show_tailscale_ip
  tailscale_ip = `tailscale ip -4 2>/dev/null`.strip
  if $?.success? && !tailscale_ip.empty?
    puts "   Tailscale: http://#{tailscale_ip}:#{PORT}"
  end
end

def show_openclaw_status
  config_path = File.expand_path("~/.openclaw/openclaw.json")
  if File.exist?(config_path)
    config = JSON.parse(File.read(config_path))
    port = config.dig("gateway", "port") || 18789
    puts "   Gateway: http://127.0.0.1:#{port} ✅"
  else
    puts "   Gateway: ~/.openclaw/openclaw.json not found ⚠️"
  end
rescue
  puts "   Gateway: config error ⚠️"
end

def help
  puts <<~HELP
    Half & Half - OpenClaw 专属客户端

    Usage: halfhalf <command>

    Commands:
      start     Start the server (installs service if needed)
      stop      Stop the server
      restart   Restart the server
      status    Show server status
      install   Install as launchd service
      uninstall Remove launchd service
      run       Run directly (used by launchd)
      help      Show this help

    Environment:
      HALFHALF_PORT  Server port (default: 3001)
  HELP
end

# Main
case ARGV[0]
when "start"   then start
when "stop"    then stop
when "restart" then restart
when "status"  then status
when "install" then install
when "uninstall" then uninstall
when "run"     then run
when "help", "-h", "--help", nil then help
else
  puts "Unknown command: #{ARGV[0]}"
  puts "Run 'halfhalf help' for usage"
  exit 1
end
